# リファクタリングチェックシート

現在の実装とCLAUDE.md仕様との乖離を整理したチェックシート。

---

## 1. エントリーポイントの分離

### 現状

| ファイル | 状態 | 内容 |
|----------|------|------|
| `main.py` | 存在 | 3モード混在（通常/文字起こしのみ/JSON分割） |
| `run_gui.py` | 存在 | GUI起動 |

### 仕様

| ファイル | 状態 | 内容 |
|----------|------|------|
| `transcribe.py` | **未作成** | 文字起こしCLI |
| `edit.py` | **未作成** | GUI起動（run_gui.pyのリネーム） |
| `split.py` | **未作成** | 書き出しCLI |

### タスク

- [ ] `transcribe.py` 新規作成
- [ ] `run_gui.py` → `edit.py` リネーム
- [ ] `split.py` 新規作成
- [ ] `main.py` 削除または後方互換ラッパーとして残す

---

## 2. Core層のprint文除去

### 現状（仕様違反）

Core層は「print文を含めない（UI非依存）」が原則だが、以下にprint文が存在。

#### src/transcribe.py（5箇所）

| 行 | 内容 | 対応 |
|----|------|------|
| 31 | `print(f"Using GPU: {gpu_name}")` | 削除またはコールバック |
| 33 | `print("Using CPU ...")` | 削除またはコールバック |
| 35 | `print(f"Loading Whisper model: ...")` | 削除またはコールバック |
| 49 | `print(f"Transcribing: ...")` | 削除またはコールバック |
| 156 | `print(f"[DEBUG] Sentence splitting: ...")` | 削除（DEBUGログ） |

#### src/splitter.py（4箇所）

| 行 | 内容 | 対応 |
|----|------|------|
| 42 | `print(f"Loading audio file: ...")` | 削除またはコールバック |
| 69 | `print(f"\nSplitting audio into ...")` | 削除またはコールバック |
| 116 | `print(f"\nGenerating metadata for ...")` | 削除またはコールバック |
| 153 | `print(f"\nMetadata saved to: ...")` | 削除またはコールバック |

### タスク

- [ ] `src/transcribe.py` からprint文を除去
- [ ] `src/splitter.py` からprint文を除去
- [ ] 進捗通知が必要な場合はコールバック関数を引数で受け取る設計に変更

---

## 3. CLI引数パースの分離

### 現状

`src/cli.py` に単一の `parse_args()` 関数があり、全オプションが混在。

```
--model, --language, --device           # Whisper関連
--output-dir                            # 共通
--margin-before, --margin-after         # 分割関連
--max-filename-length                   # 分割関連
--transcribe-only, --from-json          # モードフラグ（不要になる）
```

### 仕様

エントリーポイントごとに専用オプション。

#### transcribe.py用

| オプション | 説明 |
|-----------|------|
| `<音声ファイル>` | 入力ファイル |
| `--model` | Whisperモデル |
| `--language` | 言語コード |
| `--output-dir` | 出力ディレクトリ |
| `--device` | デバイス |

#### split.py用

| オプション | 説明 |
|-----------|------|
| `<出力ディレクトリ>` | transcript.jsonがあるディレクトリ |
| `--margin-before` | 開始前マージン |
| `--margin-after` | 終了後マージン |
| `--max-filename-length` | ファイル名最大長 |

### タスク

- [ ] `src/cli.py` を分割または関数追加
  - `parse_transcribe_args()` - transcribe.py用
  - `parse_split_args()` - split.py用
  - `parse_edit_args()` - edit.py用（オプション）
- [ ] `--transcribe-only`, `--from-json` フラグを削除

---

## 4. ファイル名の競合

### 問題

- ルートに `transcribe.py` を作成すると `src/transcribe.py` と名前が被る
- `from src.transcribe import Transcriber` は動作するが紛らわしい

### 対応案

1. **そのまま** - Pythonのモジュール解決で問題なし（srcはパッケージ）
2. **Core層をリネーム** - `src/transcriber.py` に変更
3. **エントリーポイントをリネーム** - `run_transcribe.py` に変更

### タスク

- [ ] 方針を決定（推奨: 案1でそのまま進める）

---

## 5. 既存ファイルの整理

### 更新が必要なファイル

| ファイル | 現状 | 対応 |
|----------|------|------|
| `run.bat` | `main.py` を呼び出すランチャー | `transcribe.py` を呼び出すよう更新 |

### タスク

- [ ] `run.bat` を `transcribe.py` 用に更新

---

## 実装順序（推奨）

1. **Core層のprint文除去** - 依存関係の土台を整理
2. **CLI引数パースの分離** - 新エントリーポイントの準備
3. **エントリーポイント作成** - transcribe.py, split.py, edit.py
4. **既存ファイル整理** - main.py, run_gui.py, run.bat

---

## 進捗

| カテゴリ | 完了 | 残り |
|----------|------|------|
| エントリーポイント | 3 | 0 |
| Core層print除去 | 2 | 0 |
| CLI引数パース | 1 | 0 |
| ファイル整理 | 1 | 0 |
| **合計** | **7** | **0** |

---

## 完了済みタスク

- [x] `transcribe.py` 新規作成
- [x] `run_gui.py` → `edit.py` リネーム（新規作成）
- [x] `split.py` 新規作成
- [x] `main.py` 削除
- [x] `run_gui.py` 削除
- [x] `src/transcribe.py` からprint文を除去
- [x] `src/splitter.py` からprint文を除去
- [x] `src/cli.py` を分割（parse_transcribe_args, parse_split_args, parse_edit_args）
- [x] `run.bat` を `transcribe.py` 用に更新
